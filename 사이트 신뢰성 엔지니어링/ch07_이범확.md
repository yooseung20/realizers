### 분산 시스템 모니터링의 대표적인 용어들
- 모니터링
- 화이트박스 모니터링: 
	- 시스템 내부 지표들을 토대로 하는 모니터링
	- ex) 내부 메트릭, 로그, 이벤트 등
- 블랙박스 모니터링: 
	- 외부에서 시스템이나 애플리케이션을 사용자처럼 접근하여 모니터링
	- ex) 헬스 체크, 응답 상태, 응답 시간 등
- 알림(alert)
- 근본 원인
- 노드와 머신
- 푸시(Push)

### 모니터링 해야 하는 이유
- 장기적인 트렌드 분석:
	- 점진적으로 증가하는 트래픽에 대비
- 시간순 혹은 실험 그룹에 대한 비교
- 알림
	- 문제 발생 시 노티
- 대시보드
- 임시적인 회고 분석의 수행(예를 들면 디버깅 등)
	- 원인 분석

-> 효과적인 알림 시스템은 정확한 신호와 낮은 오보 비율을 갖추어야 한다.

### 모니터링에 대한 기대치 설정
- 구글의 SRE팀은 누군가 <ins>문제를 확인하기 위해 화면을 들여다보는 상황</ins>을 배제하려고 노력한다.
- 최종 사용자의 요청률에서 예측하지 못한 변화를 탐지하는 규칙이 좋은 예.
- 낮은 샘플링 비율로 장기간에 걸쳐 관찰 실험을 실행하면 장기적인 트렌드를 놓치지 않을 수 있다.
- 종속성에 의지하는 규칙들은 알림을 보내지 않는다.
	- 데이터베이스 자체가 느린 것은 서비스적인 오류가 아니다?

### 증상과 원인(무엇과 왜)
최대 비율의 정상적 알림과 최소 비율의 오보를 목적으로 하는 모니터링 시스템을 작성할 때 고려해야 하는 가장 중요한 간극 중 하나

### 블랙박스와 화이트박스
- 중요도가 낮은 서비스: 화이트박스 모니터링 수행
- 중요한 서비스: 블랙박스 모니터링 수행

<ins>데이터베이스의 속도가 느려졌다.</ins>
- SRE 관점: 증상
- FE 관점: 원인
-> 화이트박스 모니터링을 통해 어떤 정보를 얻느냐에 따라 증상에 초점을 맞출 수도 있고 원인에 초점을 맞출 수도 있다.
-> 블랙박스 모니터링은 문제가 발생했거나 혹은 실제 증상의 원인이 된 경우에만 사람을 호출하는 원칙을 강제할 수 있다.

### 4가지 결정적인 지표
- 지연응답
	- HTTP 500 에러가 떨어지는 경우에는 응답이 굉장히 빠르게 리턴될 수 있는데, 이것은 응답 시간 관점에서 실패한 요청의 응답 시간에 해당된다. 즉 응답 시간은 성공과 실패 2가지로 나누어 봐야 한다.
- 트래픽
	- 웹 서비스: 초당 HTTP 요청 수
	- 오디오 스트리밍 시스템: 네트워크 입출력, 동시 접속 세션 수
	- key-value 저장소: 트랜잭션의 개수, QPS
- 에러: 실패한 요청의 비율
- 서비스 포화 상태: 서비스가 얼마나 포화 상태로 동작하는지를 의미 -> 목표 사용량을 정해야 함.
	- cpu 100%일 때, 서비스 장애가 발생하는 시점까지 어느 정도의 시간이 소요되는가?
	- 디스크 공간이 10% 남았는데, 앞으로 N시간 후에 바닥날 것이다.
  어떤 구간에서 어떤 지표에서 포화가 발생하는지 알아야 함. 테스트는 아주 심플해야 함. 

### 마지막 요청(혹은 실행과 성능)에 대한 고려
평균의 함정을 조심해야 한다. 밀리초를 구간으로 나눈 도수분포표를 활용하면 요청이 어떻게 분포되는지 시각적으로 활용될 수 있다.

### 적당한 측정 방법 선택
- CPU 부하를 1분 단위로 관찰한다고 해서 CPU 사용율이 갑자기 치솟아 나중에 유입된 요청들에 대한 지연응답이 발생하는 현상을 파악할 수는 없다.
- 1년에 9시간 다운타임 SLO를 가진 웹 서비스에서 1분에 한두 번 200 상태를 확인하는 것은 너무 빈번하게 확인하는 것이다.
- CloudWatch 알람 생성 주기

### 더욱 단순하게가 아니라 최대한 단순하게
모니터링 시스템을 디자인할 때 최대한 간결함을 추구해야 하는데,
특히 어떤 지표를 모니터링할 것인지를 결정할 때는 다음의 가이드 라인을 반드시 염두에 두어야 한다.
- 가장 빈번하게 발생하는 사건/사고를 탐지하기 위한 규칙은 최대한 간결하고 예측 가능하며 확실해야 한다. (ex: CPU 사용량)
- 수정 빈도가 높지 않은 데이터의 수집, 집계 그리고 알림에 관련된 설정은 제거하는 것이 좋다. (ex: 디스크 사용량)
- 수집은 되지만 대시보드에 노출되지도 않고 알림에 사용되지도 않는 데이터는 역시 제거하는 것이 좋다.

모니터링 시스템을 개발하다 보면 시스템의 상세 프로파일링(profiling), 단일 프로세스 디버깅, 예외 혹은 충돌에 대한 상세한 추적, 부하 테스트, 로그 수집 및 분석 혹은 트래픽 검사 등 <ins>여러 가지 다른 복잡한 검사 시스템을 결합하고자 하는 충동</ins>을 느낄 때가 있다.

- 온콜
	- 매번 호출기가 울릴 때마다 긴급한 상황임을 인지하고 그에 대응할 수 있어야 한다. 이러한 긴급 호출은 빈번한 호출로 인한 피로를 느끼지 않도록 하루에 단 몇 번 정도만 발생해야 한다.
	- 모든 호출은 대응이 가능해야 한다.
	- 호출에 대한 모든 대응은 이성적이어야 한다. 만일 호출이 자동화된 응답에 대해서만 가치가 있다면 이 호출은 전파되어서는 안된다.
	- 호출은 새로운 문제나 지금까지 보지 못한 사건에 대한 것이어야 한다.

### 장기적 모니터링
모니터링 시스템에 대한 의사 결정은 장기적인 목표에 기초해서 판단하는 것이 중요하다.
오늘 발생한 호출은 사람으로 하여금 내일 시스템을 향상시키고 싶은 욕구를 자극한다.

#### 빅테이블 SRE: 과도한 알림
- SLO에 근접해지면 이메일 알림이 전송되었고, SLO를 초과하면 호출기 알람이 발송
	- 너무 빈번하게 발생하여 엔지니어링 시간을 많이 소모
		- SLO 목표치를 75% 요청 지연으로 하향 조정
		- 이메일 알림 중단
#### 지메일: 사람이 예측 및 스크립팅할 수 있는 응답
무분별한 장애 알림을 우회하여 처리해야 하는가, 아니면 근본적인 문제를 해결할 것인가?
